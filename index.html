<!DOCTYPE html>
<html>
<head>
  <script>
    const personalizedSelectors = ['#bell-selector', '.nav', '#constantOUL', '#testdifferentimg'];
    const delay = 2000; //time in ms;
    (function (personalizedSelectors, delayTime) {
      const retryElements = {}; // Track selectors that need retry
      let retryCount = 0; // Counter for retries
      let retryInterval;
      function isInViewport (element) {
        const rect = element.getBoundingClientRect();
        const { innerHeight: windowHeight, innerWidth: windowWidth } = window;
        return (
          rect.bottom > 0 &&
          rect.right > 0 &&
          rect.top < windowHeight &&
          rect.left < windowWidth
        );
      };
      (function () {
        const styleContent = `
        .anti-flicker-hide {
          opacity: 0 !important
        }
        .anti-flicker-show {
          transition: opacity 0.5s, filter 0.5s !important
        }
      `;
        const styleId = 'flicker-style';
        if (!document.getElementById(styleId)) {
          const styleElement = document.createElement('style');
          styleElement.id = styleId;
          styleElement.textContent = styleContent;
          document.head.appendChild(styleElement);
        }
      })();
      function applyAntiFlicker (selectors) {
        function processSelectors (selectorElements) {
          const elements = [];
          selectorElements.forEach(selector => {
            const matchedElements = document.querySelectorAll(selector);
            if (matchedElements.length) {
              matchedElements.forEach(el => {
                console.log(isInViewport(el));
                if (!isInViewport(el)) {
                  console.log(el);
                  elements.push(el);
                }
              })
              delete retryElements[selector];
            } else {
              retryElements[selector] = false;
            }
          })
          applyStyles(elements);
        }
        function retryProcessing () {
          processSelectors(Object.keys(retryElements));
          retryCount++;
          if (Object.keys(retryElements).length === 0 || retryCount > 20) {
            retryCount = 0;
            clearInterval(retryInterval);
          }
        }
        processSelectors(selectors);
        if (Object.keys(retryElements).length) {
          retryInterval = setInterval(retryProcessing, 100);
        }
      }
      function applyStyles (elements) {
        elements.forEach(el => el.classList.add('anti-flicker-hide'))
        setTimeout(() => {
          elements.forEach(el => {
            el.classList.remove('anti-flicker-hide');
            el.classList.add('anti-flicker-show');
          })
        }, delayTime)
      }
      function observeUrlChange () {
        let previousHref = document.location.href;
        const observer = new MutationObserver(() => {
          if (previousHref !== document.location.href) {
            previousHref = document.location.href;
            applyAntiFlicker(personalizedSelectors);
          }
        })
        observer.observe(document.body, { childList: true, subtree: true });
      }
      window.addEventListener('load', () => {
        observeUrlChange();
        applyAntiFlicker(personalizedSelectors);
      })
    })(personalizedSelectors, delay);
  </script>

  <script type="text/javascript">
    const queryParams = new URLSearchParams(window.location.search)
    const accountId = queryParams.get('accountId')
    const region = queryParams.get('region')
    // var clevertap = { event: [], profile: [], account: [], region };
    var clevertap = { event: [], profile: [], account: [], region: 'sk1-staging-25', token: '012-b64' };
    clevertap.account.push({ id: "468-RZW-ZK6Z" }); // Mobile Channels (sk1-staging-25)
    //clevertap.account.push({ id: "WR5-Z98-W56Z" }); // QA Champs  
    //	              clevertap.account.push({ id: "W48-KW4-656Z" }); // WCC Team returns   
    //             clevertap.account.push({ id: "RK4-898-W85Z" }); // WA rollout qa
    //clevertap.account.push({ id: "WRK-485-456Z" }); // Web Testing RK8-84W-K66Z
    //		clevertap.account.push({ id: "RK8-84W-K66Z" }); // NPS Test 


    (function() {
      var wzrk = document.createElement("script");
      wzrk.type = "text/javascript";
      wzrk.async = true;
      //    wzrk.src = "a.js";
      //wzrk.src = "web_personalization_new_sdk";
      	  // wzrk.src = 'https://d2r1yp2w7bby2u.cloudfront.net/js/clevertap.min.js';  
      //	    wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@prompt_bugfix/clevertap.js';
      // wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@web-2622-message-pivot-id/clevertap.min.js';
      //	     wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@task/visual-editor-security/clevertap.min.js';
      //	     wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@master/clevertap.js';
      //	    wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@task/SDK-3194/inbox_msg_order/clevertap.js';
      //    wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@task/SDK-2678/frequency_caps/clevertap.js';
      //    wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@task/SDK-2521/popup_imageonly/clevertap.js';
      // wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@task/SDK-2041/web_inbox/clevertap.js'
      //	    wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@WEB-3338/clevertap.js';
//		    wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@0bf9c64c766192eeaf7e960249979ec2a209c74b/clevertap.js';
      //	    wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@b9ec8b1a15b14aa44540c5eeb1091909b5719814/clevertap.js';
       // wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@09394821ceb5bc7e6051b59d4f5172987e767f35/clevertap.js';
      // wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@e770e27fc49f521c2f30206acfaa0a8a27ef725d/clevertap.js';
      // WEB-3904: Staging URL has SSL cert issue, using jsDelivr CDN with PR branch instead
      // wzrk.src = 'https://static.wizrocket.com/staging/task/WEB-3904/customId_OUL/js/clevertap.min.js';
      wzrk.src = 'https://cdn.jsdelivr.net/gh/CleverTap/clevertap-web-sdk@task/WEB-3904/customId_OUL/clevertap.js';

        wzrk.onload = () => {
          console.log('CleverTap SDK loaded successfully');
        }

        wzrk.onerror = () => {
          console.error('Failed to load CleverTap SDK');
        }

        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(wzrk, s);
      })();

      (function () {
        const originalDispatch = EventTarget.prototype.dispatchEvent;

        EventTarget.prototype.dispatchEvent = function (event) {
          if (!(event instanceof Event)) return originalDispatch.call(this, event);

          if (event instanceof CustomEvent) {
            console.log("Custom Event Detected:", {
              type: event.type,
              detail: event.detail,
              target: event.target
            });
          }

          return originalDispatch.call(this, event);
        };
      })();
  </script>
  <style>
    .textInput { padding: 4px; margin: 2px; }
    .inputBtn { padding: 4px 8px; margin: 2px; }
  </style>
</head>
<body>
<script type="text/javascript">

  document.addEventListener('CT_web_native_display_json', (event) => {
    const eventData = event.detail;
    console.log('Custom Event Data:', eventData);
    console.log('Chetan event listener added for Json');
  });

  document.addEventListener("CT_web_native_display", function(event) {
    const data = event.detail;
    const topic = data.kv.topic;
    switch (topic) {
      case "Cart drop-off": {
        renderCartDropOffPersonalisationCampaign(data)
        break;
      }
      case "MAK1": {
        renderCartDropOffPersonalisationCampaign(data)
        break;
      }
      default: {
        renderCartDropOffPersonalisationCampaign(data)
        break;
      }
    }
  });

  function renderCartDropOffPersonalisationCampaign (data) {
    const name = data.kv.Name;
    const product = data.kv.Cart;
    clevertap.renderNotificationViewed(data);
    clevertap.renderNotificationClicked(data);
  }


  function pushprofile() {
    var id = makeid(5);
    clevertap.profile.push({
      Site: {
        Name: "User " + id,
        Email: id + "@clevertap.com",
        Phone: "+917710004770",
        Gender: "aasd",
        Employed: "Y",
        Education: "Graduate",
        Married: "Y",
        DOB: $WZRK_WR.setDate(20150501),
        Language: "Deutsche",
        "MSG-email": true,
        "MSG-push": true,
        "MSG-sms": true
      }
    });
    console.log("pushprofile successful");
  }

  function pushbid() {
    clevertap.event.push("Place Bid");
    console.log("place bid");
  }

  function pushcharged() {
    clevertap.event.push("Charged", {
      "Product name": "Casio Chronograph Watch",
      ts: new Date()
    });
    console.log("push charged");
  }

  function pushProductSearched() {
    clevertap.event.push("Product Searched");
    console.log("push Product Searched");
  }

  function pushEventAddToCart() {
    clevertap.event.push("Added to Cart", {
      "Product ID": "pr_57235721c9f9a1",
      "product name": "Lamb Curry Cut1",
      Price: 298,
      Long_1: 6473329386,
      Long_2: 2,
      Currency: "INR"
    });
  }

  function clearLocalStorage() {
    localStorage.clear();
  }

  function makeid(length) {
    var text = "";
    var possible =
      "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

    for (var i = 0; i < length; i++)
      text += possible.charAt(
        Math.floor(Math.random() * possible.length)
      );

    return text;
  }

  function logout() {
    clevertap.logout();
  }

  // WEB-3904: Helper to get customId value from input
  function getCustomId() {
    var val = document.getElementById("customIdInput").value.trim();
    return val || null;
  }

  function onClickOUL() {
    var customIdValue = getCustomId();
    var oulPayload = {
      Site: {
        Email: `qw${Math.ceil(Math.random() * 10002312)}@gmail.com`
      }
    };
    if (customIdValue) {
      oulPayload.Site.customId = customIdValue;
    }
    clevertap.onUserLogin.push(oulPayload);
    console.log("OUL pushed with payload:", JSON.stringify(oulPayload));
    getLS();
  }

  function onClickOULSame() {
    let value = document.getElementById("constantOUL").value;
    var customIdValue = getCustomId();
    var oulPayload = {
      Site: {
        Email: `${value}@gmail.com`
      }
    };
    if (customIdValue) {
      oulPayload.Site.customId = customIdValue;
    }
    clevertap.onUserLogin.push(oulPayload);
    console.log("OUL pushed with payload:", JSON.stringify(oulPayload));
    getLS();
  }

  function onClickOULIdentitySame() {
    let value = document.getElementById("constantOULIdentity").value;
    var customIdValue = getCustomId();
    var oulPayload = {
      Site: {
        Identity: `${value}`
      }
    };
    if (customIdValue) {
      oulPayload.Site.customId = customIdValue;
    }
    clevertap.onUserLogin.push(oulPayload);
    console.log("OUL pushed with payload:", JSON.stringify(oulPayload));
    getLS();
  }

  function onClickPP() {
    clevertap.profile.push({
      Site: {
        Email: `as${Math.ceil(
          Math.random() * 10002320
        )}@gmail.com`
      }
    });
    getLS();
  }

  function onClickPPSame() {
    let value = document.getElementById("constantPP").value;
    clevertap.profile.push({
      Site: {
        Email: `${value}@gmail.com`
      }
    });
  }

  function onClickPPIdentitySame() {
    let value = document.getElementById("constantPPIdentity").value;
    clevertap.profile.push({
      Site: {
        Identity: `${value}`
      }
    });
  }

  function onClickEP() {
    clevertap.event.push("Product Eaten");
    clevertap.event.push("Message Received");
    clevertap.event.push("Message Viewed");
    clevertap.event.push("Product add to cart");
    getLS();
  }

  function pushSelectedEvents() {
    var adc = document.getElementById("adc").checked;
    var ps = document.getElementById("ps").checked;
    var pv = document.getElementById("pv").checked;

    if (!adc && !ps && !pv) {
      alert("Select atleast one event");
      return;
    }
    if (adc) clevertap.event.push("Added to Cart");
    if (ps) clevertap.event.push("Product Sold");
    if (pv) clevertap.event.push("Product Viewed");

    document.getElementById("adc").checked = false;
    document.getElementById("ps").checked = false;
    document.getElementById("pv").checked = false;
    getLS();
  }

  function enablePush() {
    clevertap.notifications.push({
      apnsWebPushId: "web.com.localhost.pushDemo",
      apnsWebPushServiceUrl:
        "https://us-central1-chetan-s-demo-app.cloudfunctions.net/api",
      titleText: "Would you like to receive Push Notifications?",
      bodyText:
        "We promise to only send you relevant content and give you updates on your transactions",
      okButtonText: "Sign me up!",
      rejectButtonText: "No thanks",
      okButtonColor: "#f28046",
      hidePoweredByCT: true,
    });
  }

  function getLS() {
    var LRU_CACHE = localStorage["WZRK_X"] ? decodeURIComponent(localStorage["WZRK_X"]) : "N/A";
    var WZRK_K = localStorage["WZRK_K"] ? decodeURIComponent(localStorage["WZRK_K"]) : "N/A";
    var WZRK_G = localStorage["WZRK_G"] ? decodeURIComponent(localStorage["WZRK_G"]) : "N/A";
    var WZRK_EV = localStorage["WZRK_EV"] ? decodeURIComponent(localStorage["WZRK_EV"]) : "N/A";
    var WZRK_ARP = localStorage["WZRK_ARP"] ? decodeURIComponent(localStorage["WZRK_ARP"]) : "N/A";

    var data = `<div><strong>WZRK_K:</strong> ${WZRK_K}</div><br /><div><strong>WZRK_G (GUID):</strong> ${WZRK_G}</div><br /><div><strong>LRU_CACHE:</strong> ${LRU_CACHE}</div><br /><div><strong>WZRK_EV:</strong> ${WZRK_EV}</div><br /><div><strong>WZRK_ARP:</strong> ${WZRK_ARP}</div>`;

    document.getElementById("lsData").innerHTML = data;
  }

  function clearLS() {
    localStorage.clear();
    getLS();
  }

  function getProfile() {
    var customerType = clevertap.profile.getAttribute("Customer type");
    console.log(customerType);
  }
</script>

<div id="ct-banner" class="chetanclass">MAK HERE</div>

<div class="nav">
  <img id="bell-selector" src="https://img.icons8.com/emoji/48/000000/bell-emoji.png">
</div>

<h1>Test A-JS</h1>

<!-- WEB-3904: customId for OUL testing -->
<p><strong>Custom ID for OUL (WEB-3904)</strong></p>
<input type="text" id="customIdInput" class="textInput" placeholder="e.g. _w_my_custom_id" />
<small> (Leave empty for OUL without customId)</small>
<br /><br />

<button onclick="onClickPP()">Random PP</button>
<button onclick="onClickOUL()">Random OUL</button>
<button onclick="onClickEP()">Event Push</button>
<hr />
<br />
<p>On User Login</p>
<input type="text" id="constantOUL" class="textInput" /><input
  type="text"
  disabled
  value="@gmail.com"
  class="textInput"
/>
<button onclick="onClickOULSame()" class="inputBtn">OUL</button>
<br />
<hr />
<br />
<hr />
<p>Profile Push</p>
<input type="text" id="constantPP" class="textInput" /><input
  type="text"
  disabled
  value="@gmail.com"
  class="textInput"
/>
<button onclick="onClickPPSame()" class="inputBtn">PP</button>
<hr />

<br />
<hr />
<input type="checkbox" name="event" value="adc" id="adc" /> Added to
Cart <br />
<input type="checkbox" name="event" value="ps" id="ps" /> Product Sold
<br />
<input type="checkbox" name="event" value="pv" id="pv" /> Product Viewed
<br />
<button id="eventPushSelect" onclick="pushSelectedEvents()">
  Push Selected Events
</button>

<button id="enablePushNotifications" onclick="enablePush()">
  Enable Push Notifications
</button>
<br />
<hr />
<button
  onclick="getLS()"
  style="background: #2b39ff;color: white; padding: 5px"
>
  Show Local Storage
</button>
<br /><br />
<button
  onclick="clearLS()"
  style="background: red;color: white; padding: 5px"
>
  Clear Local Storage
</button>
<br>
<br />
<br />
<br />
<hr />

<div id="lsData"></div>
<img src="https://assets-in.bmscdn.com/discovery-catalog/events/tr:w-400,h-600,bg-CCCCCC:w-400.0,h-660.0,cm-pad_resize,bg-000000,fo-top:oi-discovery-catalog@@icons@@star-icon-202203010609.png,ox-24,oy-615,ow-29:ote-Ni40LzEwICAyMTQuM0sgVm90ZXM%3D,ots-29,otc-FFFFFF,oy-612,ox-70:q-80/et00137215-xfrypjkuws-portrait.jpg"
     alt="Trulli" width="500" height="333">
<img src="https://assets-in.bmscdn.com/discovery-catalog/events/tr:w-400,h-600,bg-CCCCCC:w-400.0,h-660.0,cm-pad_resize,bg-000000,fo-top:oi-discovery-catalog@@icons@@star-icon-202203010609.png,ox-24,oy-615,ow-29:ote-Ni40LzEwICAyMjIuNEsgVm90ZXM%3D,ots-29,otc-FFFFFF,oy-612,ox-70:q-80/et00137215-xfrypjkuws-portrait.jpg"
     alt="Trulli" width="500" height="333">
<img src="https://assets-in.bmscdn.com/promotions/cms/creatives/1682617582350_webbannernpa.jpg"
     alt="Trulli" width="500" height="333">
</body>
</html>
